<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Nasiya savdo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  padding:20px;
}

h2{
  text-align:center;
  margin-bottom:30px;
}

input{
  width:100%;
  padding:14px;
  margin-bottom:18px;
  border-radius:12px;
  border:none;
  font-size:16px;
}

button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:16px;
  font-size:17px;
  font-weight:600;
  background:linear-gradient(90deg,#f59e0b,#ef4444);
  color:white;
  cursor:pointer;
}

.back{
  margin-top:20px;
  background:linear-gradient(90deg,#3b82f6,#2563eb);
}
</style>
</head>

<body>

<h2>üí≥ Nasiya savdo</h2>

<input type="text" id="spareName" placeholder="Mahsulot nomi">
<input type="number" id="price" placeholder="Narxi">
<input type="text" id="customerName" placeholder="Mijoz ismi">

<button onclick="saveDebt()">Saqlash</button>
<button class="back" onclick="location.href='dashboard.html'">‚Üê Orqaga</button>

<script>

const firebaseConfig={
  apiKey:"AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain:"spare-shop-web.firebaseapp.com",
  projectId:"spare-shop-web",
  storageBucket:"spare-shop-web.firebasestorage.app",
  messagingSenderId:"960113811021",
  appId:"1:960113811021:web:8ae1451d3cba1148a0c604"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentUID;

auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUID = user.uid;
});

async function saveDebt(){

  if(!currentUID){
    alert("User not ready. Refresh page.");
    return;
  }

  const spareName = document.getElementById("spareName").value.trim();
  const price = Number(document.getElementById("price").value);
  const customerName = document.getElementById("customerName").value.trim();

  if(!spareName || !price || !customerName){
    alert("Barcha maydonlarni to‚Äòldiring");
    return;
  }

  const debtRef = db
    .collection("users")
    .doc(currentUID)
    .collection("debts")
    .doc(customerName);

  try {

    const doc = await debtRef.get();

    if(doc.exists){
      await debtRef.update({
        totalDebt: firebase.firestore.FieldValue.increment(price),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      await debtRef.set({
        totalDebt: price,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    alert("Nasiya saqlandi ‚úÖ");

    document.getElementById("spareName").value="";
    document.getElementById("price").value="";
    document.getElementById("customerName").value="";

  } catch(error){
    console.error(error);
    alert("Xatolik yuz berdi");
  }

}

</script>

</body>
</html>
