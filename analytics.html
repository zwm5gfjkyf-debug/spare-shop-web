<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Tahlil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  padding:20px;
}

h2{
  text-align:center;
  margin-bottom:20px;
  font-size:26px;
}

.chart-card{
  background:rgba(255,255,255,0.07);
  border-radius:22px;
  padding:25px;
  box-shadow:0 15px 40px rgba(0,0,0,0.5);
  margin-bottom:25px;
}

canvas{
  width:100% !important;
  height:380px !important;
}

.stats-card{
  background:rgba(255,255,255,0.07);
  border-radius:22px;
  padding:25px;
  box-shadow:0 15px 40px rgba(0,0,0,0.5);
  margin-bottom:25px;
  line-height:1.9;
  font-size:18px;
}

.back-btn{
  width:100%;
  padding:16px;
  border:none;
  border-radius:18px;
  background:linear-gradient(90deg,#3b82f6,#2563eb);
  color:white;
  font-size:18px;
  cursor:pointer;
  font-weight:600;
  transition:0.2s;
}

.back-btn:hover{
  transform:translateY(-3px);
}

.back-btn:active{
  transform:scale(0.97);
}
</style>
</head>

<body>

<h2>ğŸ“Š Tahlil</h2>

<div class="chart-card">
  <canvas id="analyticsChart"></canvas>
</div>

<div class="stats-card" id="analyticsStats">
  Yuklanmoqda...
</div>

<button class="back-btn" onclick="location.href='dashboard.html'">
  â† Orqaga
</button>

<script>

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain: "spare-shop-web.firebaseapp.com",
  projectId: "spare-shop-web",
  storageBucket: "spare-shop-web.firebasestorage.app",
  messagingSenderId: "960113811021",
  appId: "1:960113811021:web:8ae1451d3cba1148a0c604"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const ctx = document.getElementById("analyticsChart").getContext("2d");
let chart;

/* ================= AUTH ================= */

auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  loadAnalytics(user.uid);
});

/* ================= LOAD ANALYTICS ================= */

function loadAnalytics(uid){

  db.collection("users")
    .doc(uid)
    .collection("sales")
    .orderBy("createdAt")
    .get()
    .then(snapshot=>{

      if(snapshot.empty){
        document.getElementById("analyticsStats").innerHTML="Ma'lumot yoâ€˜q";
        return;
      }

      let total=0;
      let labels=[];
      let data=[];

      let hourTotals={};
      let dayTotals={};
      let productCount={};

      snapshot.forEach(doc=>{
        const sale=doc.data();
        if(!sale.createdAt) return;

        const date=sale.createdAt.toDate();
        const hour=date.getHours();
        const day=date.toLocaleDateString("uz-UZ");

        total+=sale.price;
        labels.push(labels.length+1);
        data.push(total);

        hourTotals[hour]=(hourTotals[hour]||0)+sale.price;
        dayTotals[day]=(dayTotals[day]||0)+sale.price;
        productCount[sale.name]=(productCount[sale.name]||0)+1;
      });

      drawChart(labels,data);

      const bestHour=Object.entries(hourTotals).sort((a,b)=>b[1]-a[1])[0];
      const bestDay=Object.entries(dayTotals).sort((a,b)=>b[1]-a[1])[0];
      const topProduct=Object.entries(productCount).sort((a,b)=>b[1]-a[1])[0];

      const growth = ((data[data.length-1] - data[0]) / data[0] * 100).toFixed(1);

      document.getElementById("analyticsStats").innerHTML=`
        ğŸ•’ Eng yaxshi soat: <b>${bestHour ? bestHour[0]+":00" : "-"}</b><br>
        ğŸ“… Eng yaxshi kun: <b>${bestDay ? bestDay[0] : "-"}</b><br>
        ğŸ’ Eng koâ€˜p sotilgan mahsulot: <b>${topProduct ? topProduct[0] : "-"}</b><br>
        ğŸ“ˆ Oâ€˜sish: <b>${isFinite(growth)?growth:0}%</b>
      `;

    });
}

/* ================= DRAW CHART ================= */

function drawChart(labels,data){

  if(chart) chart.destroy();

  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[{
        data,
        borderColor:"#22c55e",
        backgroundColor:"rgba(34,197,94,0.2)",
        fill:true,
        tension:0.4,
        pointRadius:4
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        y:{
          ticks:{
            callback:value=>value+" soâ€˜m"
          }
        }
      }
    }
  });
}

</script>

</body>
</html>
