<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Tahlil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>

/* ===== GLOBAL ===== */
*{box-sizing:border-box;}

body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f172a,#111827,#1e293b);
  color:white;
  padding:25px;
  animation:fadeIn 0.6s ease forwards;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(10px);}
  to{opacity:1; transform:translateY(0);}
}

h2{
  text-align:center;
  margin-bottom:25px;
  font-size:26px;
  font-weight:600;
}

/* ===== GLASS CARD ===== */
.glass{
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(16px);
  border-radius:26px;
  padding:25px;
  box-shadow:0 20px 50px rgba(0,0,0,0.5);
  transition:all 0.3s ease;
}

.glass:hover{
  transform:translateY(-4px);
}

/* ===== CHART ===== */
.chart-card{
  margin-bottom:30px;
}

canvas{
  width:100% !important;
  height:380px !important;
}

/* ===== STATS GRID ===== */
.stats-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
  margin-bottom:30px;
}

.stat-card{
  padding:20px;
  border-radius:22px;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(14px);
  box-shadow:0 12px 35px rgba(0,0,0,0.45);
  transition:all 0.3s ease;
}

.stat-card:hover{
  transform:translateY(-4px);
  box-shadow:0 18px 45px rgba(0,0,0,0.6);
}

.stat-title{
  font-size:14px;
  opacity:0.7;
  margin-bottom:10px;
}

.stat-value{
  font-size:22px;
  font-weight:600;
}

/* ===== BUTTON ===== */
.back-btn{
  width:100%;
  padding:18px;
  border:none;
  border-radius:22px;
  background:linear-gradient(90deg,#3b82f6,#2563eb);
  color:white;
  font-size:18px;
  cursor:pointer;
  font-weight:600;
  transition:all 0.25s ease;
}

.back-btn:hover{
  transform:translateY(-3px);
  box-shadow:0 15px 35px rgba(59,130,246,0.5);
}

.back-btn:active{
  transform:scale(0.96);
}

</style>
</head>

<body>

<h2>üìä Tahlil</h2>

<div class="glass chart-card">
  <canvas id="analyticsChart"></canvas>
</div>

<div class="stats-grid">

  <div class="stat-card">
    <div class="stat-title">üíµ Naqd tushum</div>
    <div class="stat-value" id="cashRevenue">0 so‚Äòm</div>
  </div>

  <div class="stat-card">
    <div class="stat-title">üì¶ Sotilgan mahsulotlar</div>
    <div class="stat-value" id="totalItems">0 dona</div>
  </div>

  <div class="stat-card">
    <div class="stat-title">ü•á Eng ko‚Äòp sotilgan</div>
    <div class="stat-value" id="topProduct">‚Äî</div>
  </div>

</div>

<button class="back-btn" onclick="smoothBack()">
  ‚Üê Orqaga
</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain: "spare-shop-web.firebaseapp.com",
  projectId: "spare-shop-web",
  storageBucket: "spare-shop-web.firebasestorage.app",
  messagingSenderId: "960113811021",
  appId: "1:960113811021:web:8ae1451d3cba1148a0c604"
};

if(!firebase.apps.length){
  firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.firestore();

const ctx = document.getElementById("analyticsChart").getContext("2d");
let chart;

auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  loadAnalytics(user.uid);
});

function loadAnalytics(uid){

  let cashRevenue = 0;
  let totalItems = 0;
  let productCount = {};
  let cumulative = [];
  let labels = [];
  let sum = 0;

  db.collection("users")
    .doc(uid)
    .collection("sales")
    .orderBy("createdAt")
    .get()
    .then(snapshot=>{

      snapshot.forEach((doc,index)=>{
        const sale = doc.data();
        if(!sale.createdAt) return;

        const price = Number(sale.price);
        if(isNaN(price)) return;

        cashRevenue += price;
        totalItems++;

        if(sale.name){
          productCount[sale.name] = (productCount[sale.name]||0)+1;
        }

        sum += price;
        cumulative.push(sum);
        labels.push(index+1);
      });

      const top = Object.entries(productCount)
        .sort((a,b)=>b[1]-a[1])[0];

      document.getElementById("cashRevenue").innerText =
        cashRevenue.toLocaleString() + " so‚Äòm";

      document.getElementById("totalItems").innerText =
        totalItems + " dona";

      document.getElementById("topProduct").innerText =
        top ? top[0] : "‚Äî";

      drawChart(labels,cumulative);
    });
}

function drawChart(labels,data){

  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"line",
    data:{
      labels:labels,
      datasets:[{
        data:data,
        borderColor:"#22c55e",
        backgroundColor:"rgba(34,197,94,0.2)",
        fill:true,
        tension:0.4,
        pointRadius:4
      }]
    },
    options:{
      responsive:true,
      animation:{duration:1000},
      plugins:{legend:{display:false}},
      scales:{
        y:{
          ticks:{
            color:"white",
            callback:value=>value.toLocaleString()+" so‚Äòm"
          },
          grid:{color:"rgba(255,255,255,0.05)"}
        },
        x:{
          ticks:{color:"white"},
          grid:{display:false}
        }
      }
    }
  });
}

/* Smooth back */
function smoothBack(){
  document.body.style.opacity="0";
  document.body.style.transition="0.3s";
  setTimeout(()=>{
    window.location.href="dashboard.html";
  },300);
}

</script>

</body>
</html>
