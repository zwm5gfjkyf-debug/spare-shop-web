<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Tahlil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  padding:20px;
}

h2{
  text-align:center;
  margin-bottom:20px;
  font-size:26px;
}

.chart-card{
  background:rgba(255,255,255,0.07);
  border-radius:22px;
  padding:25px;
  box-shadow:0 15px 40px rgba(0,0,0,0.5);
  margin-bottom:25px;
}

canvas{
  width:100% !important;
  height:380px !important;
}

.stats-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
  margin-bottom:25px;
}

.stat-card{
  background:rgba(255,255,255,0.07);
  padding:18px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}

.stat-title{
  font-size:14px;
  opacity:0.7;
  margin-bottom:8px;
}

.stat-value{
  font-size:20px;
  font-weight:600;
}

.back-btn{
  width:100%;
  padding:16px;
  border:none;
  border-radius:18px;
  background:linear-gradient(90deg,#3b82f6,#2563eb);
  color:white;
  font-size:18px;
  cursor:pointer;
  font-weight:600;
}
</style>
</head>

<body>

<h2>ğŸ“Š Tahlil</h2>

<div class="chart-card">
  <canvas id="analyticsChart"></canvas>
</div>

<div class="stats-grid">

  <div class="stat-card">
    <div class="stat-title">ğŸ’µ Naqd tushum</div>
    <div class="stat-value" id="cashRevenue">0 soâ€˜m</div>
  </div>

  <div class="stat-card">
    <div class="stat-title">ğŸ“¦ Sotilgan mahsulotlar</div>
    <div class="stat-value" id="totalItems">0 dona</div>
  </div>


  <div class="stat-card">
    <div class="stat-title">ğŸ¥‡ Eng koâ€˜p sotilgan</div>
    <div class="stat-value" id="topProduct">â€”</div>
  </div>

</div>

<button class="back-btn" onclick="location.href='dashboard.html'">
  â† Orqaga
</button>

<script>

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain: "spare-shop-web.firebaseapp.com",
  projectId: "spare-shop-web",
  storageBucket: "spare-shop-web.firebasestorage.app",
  messagingSenderId: "960113811021",
  appId: "1:960113811021:web:8ae1451d3cba1148a0c604"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const ctx = document.getElementById("analyticsChart").getContext("2d");
let chart;

auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  loadAnalytics(user.uid);
});

function loadAnalytics(uid){

  let cashRevenue = 0;
  let totalItems = 0;
  let productCount = {};
  let cumulative = [];
  let labels = [];
  let sum = 0;

  // ğŸ”¹ LOAD NAQD SALES
  db.collection("users")
    .doc(uid)
    .collection("sales")
    .orderBy("createdAt")
    .get()
    .then(snapshot=>{

      snapshot.forEach((doc,index)=>{
        const sale = doc.data();
        if(!sale.createdAt) return;

        const price = Number(sale.price);
        if(isNaN(price)) return;

        cashRevenue += price;
        totalItems++;

        if(sale.name){
          productCount[sale.name] = (productCount[sale.name]||0)+1;
        }

        sum += price;
        cumulative.push(sum);
        labels.push(index+1);
      });

      const avgSale = totalItems ? Math.round(cashRevenue/totalItems) : 0;

      const top = Object.entries(productCount)
        .sort((a,b)=>b[1]-a[1])[0];

      document.getElementById("cashRevenue").innerText =
        cashRevenue.toLocaleString() + " soâ€˜m";

      document.getElementById("totalItems").innerText =
        totalItems + " dona";

      document.getElementById("avgSale").innerText =
        avgSale.toLocaleString() + " soâ€˜m";

      document.getElementById("topProduct").innerText =
        top ? top[0] : "â€”";

      drawChart(labels,cumulative);

      // ğŸ”¹ LOAD NASIYA
      db.collection("users")
        .doc(uid)
        .collection("debts")
        .get()
        .then(debtSnap=>{

          let debtRevenue = 0;

          debtSnap.forEach(doc=>{
            const debt = doc.data();
            if(debt.totalDebt){
              debtRevenue += Number(debt.totalDebt);
            }
          });

          document.getElementById("debtRevenue").innerText =
            debtRevenue.toLocaleString() + " soâ€˜m";

          const total = cashRevenue + debtRevenue;

          document.getElementById("totalRevenue").innerText =
            total.toLocaleString() + " soâ€˜m";

        });

    });
}

function drawChart(labels,data){

  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"line",
    data:{
      labels:labels,
      datasets:[{
        data:data,
        borderColor:"#22c55e",
        backgroundColor:"rgba(34,197,94,0.2)",
        fill:true,
        tension:0.4,
        pointRadius:4
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        y:{
          ticks:{
            callback:value=>value.toLocaleString()+" soâ€˜m"
          }
        }
      }
    }
  });
}
</script>

</body>
</html>
