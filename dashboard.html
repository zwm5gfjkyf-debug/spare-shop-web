<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<title>Spare Shop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#16a34a">

<style>
*{box-sizing:border-box;}

body{
  margin:0;
  font-family:'Segoe UI', Arial, sans-serif;
  background:linear-gradient(135deg,#0f172a,#111827,#1e293b);
  color:white;
  padding:25px;
  padding-bottom:160px;
  min-height:100vh;
  display:none;
  animation:fadeIn 0.6s ease forwards;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(10px);}
  to{opacity:1; transform:translateY(0);}
}

.header{
  font-size:24px;
  font-weight:600;
  margin-bottom:30px;
}

.top{
  display:flex;
  gap:18px;
  flex-wrap:wrap;
}

.big{
  flex:1;
  min-width:260px;
  padding:25px;
  border-radius:24px;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(18px);
  box-shadow:0 20px 50px rgba(0,0,0,0.5);
  transition:all 0.3s ease;
}

.big:hover{
  transform:translateY(-5px);
}

.big h1{
  margin:14px 0 0;
  font-size:32px;
}

.cards{
  margin-top:30px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
}

.card{
  padding:20px;
  border-radius:20px;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(14px);
  box-shadow:0 15px 40px rgba(0,0,0,0.45);
  transition:all 0.3s ease;
}

.card:hover{
  transform:translateY(-4px);
}

.card h3{
  margin:0 0 10px;
  font-size:14px;
  opacity:0.7;
}

.card p{
  margin:0;
  font-size:18px;
  font-weight:600;
}

.actions{
  margin-top:40px;
  display:flex;
  flex-direction:column;
  gap:16px;
}

.actions button{
  padding:18px;
  border:none;
  border-radius:22px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  color:white;
  transition:all 0.25s ease;
}

.actions button:hover{
  transform:translateY(-4px);
  box-shadow:0 18px 40px rgba(0,0,0,0.6);
}

.actions button:active{
  transform:scale(0.97);
}

/* Button Colors */
.sell{ background:linear-gradient(90deg,#22c55e,#16a34a); }
.analytics{ background:linear-gradient(90deg,#3b82f6,#2563eb); }
.debtAnalytics{ background:linear-gradient(90deg,#f59e0b,#ef4444); }
.products{ background:linear-gradient(90deg,#06b6d4,#0ea5e9); }
.addProduct{ background:linear-gradient(90deg,#8b5cf6,#7c3aed); }

.skeleton {
  background: linear-gradient(
    90deg,
    rgba(255,255,255,0.08) 25%,
    rgba(255,255,255,0.15) 50%,
    rgba(255,255,255,0.08) 75%
  );
  background-size: 200% 100%;
  animation: loading 1.2s infinite;
  border-radius: 6px;
  color: transparent;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
</style>
</head>

<body>

<div class="header">Spare Shop</div>

<div class="top">
  <div class="big">
    <div>Bugun sotildi</div>
    <h1 id="todayCount" class="skeleton">000</h1>
  </div>

  <div class="big">
    <div>Bugungi tushum</div>
    <h1 id="todayTotal" class="skeleton">000</h1>
  </div>
</div>

<div class="cards">
  <div class="card">
    <h3>Nasiya tovar</h3>
    <p id="debtCount" class="skeleton">000</p>
  </div>

  <div class="card">
    <h3>Umumiy nasiya</h3>
    <p id="debtTotal" class="skeleton">000</p>
  </div>

  <div class="card">
    <h3>Bu hafta</h3>
    <p id="weekData" class="skeleton">000</p>
  </div>

  <div class="card">
    <h3>Bu oy</h3>
    <p id="monthData" class="skeleton">000</p>
  </div>

  <div class="card">
    <h3>Eng koâ€˜p sotilgan</h3>
    <p id="topProduct" class="skeleton">000</p>
  </div>
</div>

<div class="actions">

  <button class="sell" onclick="location.href='/add-type.html'">
    ðŸ’° Tovar sotish
  </button>

  <button class="analytics" onclick="location.href='/sales.html'">
    ðŸ“Š Tahlil
  </button>
  
<button onclick="location.href='daily-analytics.html'">
  ðŸ“… Kunlik tahlil
</button>
  
  <button class="debtAnalytics" onclick="location.href='/nasiya-analytics.html'">
    ðŸ’³ Nasiya Tahlil
  </button>

  <button class="products" onclick="location.href='/products.html'">
    ðŸ“¦ Barcha tovarlar
  </button>

  <button class="addProduct" onclick="location.href='/products-add.html'">
    âž• Yangi tovar qoâ€˜shish
  </button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain:"spare-shop-web.firebaseapp.com",
  projectId:"spare-shop-web",
  storageBucket:"spare-shop-web.firebasestorage.app",
  messagingSenderId:"960113811021",
  appId:"1:960113811021:web:8ae1451d3cba1148a0c604"
};

if(!firebase.apps.length){
  firebase.initializeApp(firebaseConfig);
}

const auth=firebase.auth();
const db=firebase.firestore();

auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href="/login.html";
    return;
  }

  document.body.style.display="block";
  loadDashboard(user.uid);
});

function loadDashboard(uid){

  const todayStart=new Date();
  todayStart.setHours(0,0,0,0);

  const tomorrowStart=new Date(todayStart);
  tomorrowStart.setDate(todayStart.getDate()+1);

  const weekStart=new Date(todayStart);
  weekStart.setDate(todayStart.getDate()-6);

  const monthStart=new Date(todayStart);
  monthStart.setDate(1);

  db.collection("users").doc(uid).collection("sales")
  .onSnapshot(snapshot=>{

    let tC=0,tS=0,wC=0,wS=0,mC=0,mS=0;
    const productCount={};

    snapshot.forEach(doc=>{
      const s=doc.data();
      if(!s.createdAt) return;

      const d=s.createdAt.toDate();
      const price=Number(s.price||0);

      if(d>=todayStart && d<tomorrowStart){
        tS+=price;
        if(!s.type || s.type==="product") tC++;
      }

      if(d>=weekStart){
        wS+=price;
        if(!s.type || s.type==="product") wC++;
      }

      if(d>=monthStart){
        mS+=price;
        if(!s.type || s.type==="product") mC++;
      }

      if(!s.type || s.type==="product"){
        productCount[s.name]=(productCount[s.name]||0)+1;
      }
    });

    updateUI("todayCount", tC+" dona");
    updateUI("todayTotal", tS.toLocaleString()+" soâ€˜m");
    updateUI("weekData", wC+" dona / "+wS.toLocaleString()+" soâ€˜m");
    updateUI("monthData", mC+" dona / "+mS.toLocaleString()+" soâ€˜m");

    const top=Object.entries(productCount).sort((a,b)=>b[1]-a[1])[0];
    updateUI("topProduct", top?top[0]+" ("+top[1]+" marta)":"â€”");
  });

  db.collection("users").doc(uid).collection("debts")
  .onSnapshot(snapshot=>{
    let count=0,total=0;
    snapshot.forEach(doc=>{
      const d=doc.data();
      count+=Number(d.totalItems||0);
      total+=Number(d.totalDebt||0);
    });

    updateUI("debtCount", count+" ta");
    updateUI("debtTotal", total.toLocaleString()+" soâ€˜m");
  });
}

function updateUI(id,value){
  const el=document.getElementById(id);
  el.innerText=value;
  el.classList.remove("skeleton");
}
</script>

</body>
</html>
