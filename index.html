<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<title>Spare Shop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#16a34a">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  margin:0;
  font-family:'Segoe UI', Arial, sans-serif;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  padding:20px;
  padding-bottom:110px;
  min-height:100vh;
  display:none; /* ðŸ”¥ hide page until auth ready */
}

/* Skeleton */
.skeleton {
  background: linear-gradient(
    90deg,
    rgba(255,255,255,0.08) 25%,
    rgba(255,255,255,0.15) 50%,
    rgba(255,255,255,0.08) 75%
  );
  background-size: 200% 100%;
  animation: loading 1.2s infinite;
  border-radius: 6px;
  color: transparent;
}
@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.header{font-size:22px;font-weight:600;margin-bottom:25px;}
.top{display:flex;gap:15px;flex-wrap:wrap;}
.big{flex:1;min-width:260px;padding:22px;border-radius:20px;background:rgba(255,255,255,0.08);backdrop-filter:blur(12px);box-shadow:0 10px 30px rgba(0,0,0,0.35);}
.big h1{margin:12px 0 0;font-size:34px;}

.cards{margin-top:25px;display:grid;grid-template-columns:1fr 1fr;gap:15px;}
.card{background:rgba(255,255,255,0.07);padding:18px;border-radius:18px;box-shadow:0 6px 20px rgba(0,0,0,0.3);}
.card h3{margin:0 0 8px;font-size:15px;opacity:0.8;}
.card p{margin:0;font-size:16px;font-weight:600;}

.actions{margin-top:35px;display:flex;flex-direction:column;gap:18px;}
.actions button{padding:18px;border:none;border-radius:20px;font-size:18px;font-weight:600;cursor:pointer;}

.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;height:65px;
  background:#0f172a;display:flex;justify-content:space-around;
  align-items:center;border-top:1px solid rgba(255,255,255,0.1);
}
</style>
</head>

<body>

<div class="header">Spare Shop</div>

<div class="top">
  <div class="big">
    <div>Bugun sotildi</div>
    <h1 id="todayCount" class="skeleton">000</h1>
  </div>

  <div class="big">
    <div>Bugungi tushum</div>
    <h1 id="todayTotal" class="skeleton">000</h1>
  </div>
</div>

<div class="cards">
  <div class="card">
    <h3>Nasiya tovar</h3>
    <p id="debtCount" class="skeleton">000</p>
  </div>

  <div class="card">
    <h3>Umumiy nasiya</h3>
    <p id="debtTotal" class="skeleton">000</p>
  </div>

  <div class="card">
    <h3>Bu hafta</h3>
    <p id="weekData" class="skeleton">000</p>
  </div>

  <div class="card">
    <h3>Bu oy</h3>
    <p id="monthData" class="skeleton">000</p>
  </div>

  <div class="card">
    <h3>Eng koâ€˜p sotilgan</h3>
    <p id="topProduct" class="skeleton">000</p>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>

const firebaseConfig={
  apiKey:"AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain:"spare-shop-web.firebaseapp.com",
  projectId:"spare-shop-web",
  storageBucket:"spare-shop-web.firebasestorage.app",
  messagingSenderId:"960113811021",
  appId:"1:960113811021:web:8ae1451d3cba1148a0c604"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

/* ================= AUTH ================= */

auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href="index.html";
    return;
  }

  document.body.style.display="block"; // ðŸ”¥ show page only after auth
  loadDashboard(user.uid);
});

/* ================= DASHBOARD ================= */

function loadDashboard(uid){

  const todayStart=new Date();
  todayStart.setHours(0,0,0,0);

  const tomorrowStart=new Date(todayStart);
  tomorrowStart.setDate(todayStart.getDate()+1);

  const weekStart=new Date(todayStart);
  weekStart.setDate(todayStart.getDate()-6);

  const monthStart=new Date(todayStart);
  monthStart.setDate(1);

  /* SALES REALTIME */
  db.collection("users").doc(uid).collection("sales")
  .onSnapshot(snapshot=>{

    let tC=0,tS=0,wC=0,wS=0,mC=0,mS=0;
    const productCount={};

    snapshot.forEach(doc=>{
      const s=doc.data();
      if(!s.createdAt) return;

      const d=s.createdAt.toDate();
      const price=Number(s.price||0);

      if(d>=todayStart && d<tomorrowStart){
        tS+=price;
        if(!s.type || s.type==="product") tC++;
      }

      if(d>=weekStart){
        wS+=price;
        if(!s.type || s.type==="product") wC++;
      }

      if(d>=monthStart){
        mS+=price;
        if(!s.type || s.type==="product") mC++;
      }

      if(!s.type || s.type==="product"){
        productCount[s.name]=(productCount[s.name]||0)+1;
      }
    });

    updateUI("todayCount", tC+" dona");
    updateUI("todayTotal", tS.toLocaleString()+" soâ€˜m");
    updateUI("weekData", wC+" dona / "+wS.toLocaleString()+" soâ€˜m");
    updateUI("monthData", mC+" dona / "+mS.toLocaleString()+" soâ€˜m");

    const top=Object.entries(productCount).sort((a,b)=>b[1]-a[1])[0];
    updateUI("topProduct", top?top[0]+" ("+top[1]+" marta)":"â€”");

  });

  /* NASIYA REALTIME */
  db.collection("users").doc(uid).collection("debts")
  .onSnapshot(snapshot=>{

    let count=0,total=0;

    snapshot.forEach(doc=>{
      const d=doc.data();
      count+=Number(d.totalItems||0);
      total+=Number(d.totalDebt||0);
    });

    updateUI("debtCount", count+" ta");
    updateUI("debtTotal", total.toLocaleString()+" soâ€˜m");
  });
}

/* Remove skeleton safely */
function updateUI(id,value){
  const el=document.getElementById(id);
  el.innerText=value;
  el.classList.remove("skeleton");
}

</script>
</body>
</html>
