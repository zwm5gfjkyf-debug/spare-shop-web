<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>üí≥ Nasiya Tahlil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f172a,#111827,#1e293b);
  color:white;
  padding:20px;
}

h2{text-align:center;margin-bottom:30px;}

.stats{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
  margin-bottom:30px;
}

.card{
  background:rgba(255,255,255,0.07);
  padding:22px;
  border-radius:22px;
  backdrop-filter:blur(15px);
}

.customer{
  background:rgba(255,255,255,0.06);
  padding:22px;
  border-radius:22px;
  margin-bottom:20px;
}

.section-title{margin-top:14px;font-size:12px;opacity:0.6;}
.item-line{font-size:13px;margin:5px 0;}
.payment-line{font-size:13px;color:#22c55e;margin:5px 0;}

.pay-btn{
  margin-top:15px;
  padding:10px 16px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  background:linear-gradient(90deg,#22c55e,#16a34a);
  color:white;
}

.back-btn{
  margin-top:30px;
  width:100%;
  padding:16px;
  border:none;
  border-radius:20px;
  background:linear-gradient(90deg,#3b82f6,#2563eb);
  color:white;
  font-size:16px;
  cursor:pointer;
}

/* ===== PAYMENT MODAL ===== */

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  backdrop-filter:blur(6px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}

.modal-box{
  background:linear-gradient(135deg,#1e293b,#0f172a);
  padding:30px;
  border-radius:22px;
  width:90%;
  max-width:380px;
}

.modal-box input{
  width:100%;
  padding:14px;
  margin-top:15px;
  border-radius:12px;
  border:none;
  font-size:16px;
}

.modal-buttons{
  display:flex;
  gap:10px;
  margin-top:20px;
}

.modal-buttons button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:600;
}

.cancel{background:#ef4444;color:white;}
.confirm{background:#22c55e;color:white;}
</style>
</head>

<body>

<h2>üí≥ Nasiya Tahlil</h2>

<div class="stats">
  <div class="card">
    <h3>üì¶ Jami nasiya tovar</h3>
    <p id="totalItems">0 ta</p>
  </div>
  <div class="card">
    <h3>üí∞ Umumiy nasiya summa</h3>
    <p id="totalDebt">0 so‚Äòm</p>
  </div>
</div>

<div id="customerList"></div>

<button class="back-btn" onclick="location.href='dashboard.html'">
‚Üê Orqaga
</button>

<script>
const firebaseConfig={
  apiKey:"AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain:"spare-shop-web.firebaseapp.com",
  projectId:"spare-shop-web",
  storageBucket:"spare-shop-web.firebasestorage.app",
  messagingSenderId:"960113811021",
  appId:"1:960113811021:web:8ae1451d3cba1148a0c604"
};


if(!firebase.apps.length){
  firebase.initializeApp(firebaseConfig);
}

const auth=firebase.auth();
const db=firebase.firestore();

let selectedCustomer=null;

auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  loadNasiya(user.uid);
});

function loadNasiya(uid){

  let totalDebt=0;
  let totalItems=0;

  const list=document.getElementById("customerList");
  list.innerHTML="";

  db.collection("users").doc(uid).collection("debts").get()
  .then(snapshot=>{

    snapshot.forEach(async doc=>{

      const data=doc.data();
      const name=doc.id;

      const debt=Number(data.totalDebt||0);
      const itemsCount=Number(data.totalItems||0);

      totalDebt+=debt;
      totalItems+=itemsCount;

      const div=document.createElement("div");
      div.className="customer";
      div.innerHTML=`
        <h4>üë§ ${name}</h4>
        <p>üì¶ ${itemsCount} ta | üí∞ ${debt.toLocaleString()} so‚Äòm</p>
        <div id="items-${name}"></div>
        <div id="payments-${name}"></div>
        <button class="pay-btn" onclick="openModal('${name}')">üí∏ To‚Äòlandi</button>
      `;
      list.appendChild(div);
    });

    document.getElementById("totalDebt").innerText=totalDebt.toLocaleString()+" so‚Äòm";
    document.getElementById("totalItems").innerText=totalItems+" ta";
  });
}

/* ===== MODAL ===== */

function openModal(customerName){
  selectedCustomer=customerName;
  document.getElementById("modalCustomer").innerText="Mijoz: "+customerName;
  document.getElementById("paymentAmount").value="";
  document.getElementById("paymentModal").style.display="flex";
}

function closeModal(){
  document.getElementById("paymentModal").style.display="none";
}

async function confirmPayment(){

  const amount=Number(document.getElementById("paymentAmount").value);
  if(!amount||amount<=0){alert("To‚Äòg‚Äòri summa kiriting");return;}

  const user=auth.currentUser;
  if(!user) return;

  const debtRef=db.collection("users").doc(user.uid)
    .collection("debts").doc(selectedCustomer);

  const doc=await debtRef.get();
  if(!doc.exists) return;

  const currentDebt=doc.data().totalDebt||0;
  const newDebt=currentDebt-amount;

  await debtRef.collection("payments").add({
    amount:amount,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection("users").doc(user.uid).collection("sales").add({
    name:"Nasiya to‚Äòlov ("+selectedCustomer+")",
    price:amount,
    type:"payment",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  if(newDebt<=0){ await debtRef.delete(); }
  else{
    await debtRef.update({
      totalDebt:newDebt,
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  closeModal();
  location.reload();
}
</script>

<div id="paymentModal" class="modal">
  <div class="modal-box">
    <h3>üí≥ To‚Äòlov qilish</h3>
    <p id="modalCustomer"></p>
    <input type="number" id="paymentAmount" placeholder="Masalan: 100000">
    <div class="modal-buttons">
      <button class="cancel" onclick="closeModal()">Bekor qilish</button>
      <button class="confirm" onclick="confirmPayment()">Tasdiqlash</button>
    </div>
  </div>
</div>

</body>
</html>
