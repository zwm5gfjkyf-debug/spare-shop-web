<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>üí≥ Nasiya Tahlil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f172a,#111827,#1e293b);
  color:white;
  padding:20px;
  animation:fadeIn 0.5s ease forwards;
}

@keyframes fadeIn{
  from{opacity:0;}
  to{opacity:1;}
}

h2{
  text-align:center;
  margin-bottom:30px;
  font-size:24px;
  font-weight:600;
}

.stats{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
  margin-bottom:30px;
}

.card{
  background:rgba(255,255,255,0.07);
  padding:22px;
  border-radius:22px;
  backdrop-filter:blur(15px);
  box-shadow:0 15px 40px rgba(0,0,0,0.5);
  transition:all 0.25s ease;
}

.card:hover{
  transform:translateY(-5px);
  box-shadow:0 20px 50px rgba(0,0,0,0.7);
}

.card h3{
  margin:0 0 10px;
  font-size:13px;
  opacity:0.7;
}

.card p{
  font-size:20px;
  font-weight:600;
  margin:0;
}

.customer{
  background:rgba(255,255,255,0.06);
  padding:22px;
  border-radius:22px;
  margin-bottom:20px;
  backdrop-filter:blur(10px);
  box-shadow:0 12px 30px rgba(0,0,0,0.4);
  animation:slideUp 0.4s ease forwards;
}

@keyframes slideUp{
  from{opacity:0; transform:translateY(20px);}
  to{opacity:1; transform:translateY(0);}
}

.customer h4{
  margin:0 0 10px;
}

.section-title{
  margin-top:14px;
  font-size:12px;
  opacity:0.6;
}

.item-line{
  font-size:13px;
  margin:5px 0;
}

.payment-line{
  font-size:13px;
  color:#22c55e;
  margin:5px 0;
}

.pay-btn{
  margin-top:15px;
  padding:10px 16px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  background:linear-gradient(90deg,#22c55e,#16a34a);
  color:white;
  transition:all 0.25s ease;
}

.pay-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 25px rgba(34,197,94,0.5);
}

.back-btn{
  margin-top:30px;
  width:100%;
  padding:16px;
  border:none;
  border-radius:20px;
  background:linear-gradient(90deg,#3b82f6,#2563eb);
  color:white;
  font-size:16px;
  cursor:pointer;
  font-weight:600;
  transition:all 0.25s ease;
}

.back-btn:hover{
  transform:translateY(-3px);
  box-shadow:0 15px 35px rgba(59,130,246,0.5);
}

</style>
</head>

<body>

<h2>üí≥ Nasiya Tahlil</h2>

<div class="stats">
  <div class="card">
    <h3>üì¶ Jami nasiya tovar</h3>
    <p id="totalItems">0 ta</p>
  </div>

  <div class="card">
    <h3>üí∞ Umumiy nasiya summa</h3>
    <p id="totalDebt">0 so‚Äòm</p>
  </div>
</div>

<div id="customerList"></div>

<button class="back-btn" onclick="location.href='dashboard.html'">
‚Üê Orqaga
</button>

<script>
const firebaseConfig={
  apiKey:"AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain:"spare-shop-web.firebaseapp.com",
  projectId:"spare-shop-web",
  storageBucket:"spare-shop-web.firebasestorage.app",
  messagingSenderId:"960113811021",
  appId:"1:960113811021:web:8ae1451d3cba1148a0c604"
};

if(!firebase.apps.length){
  firebase.initializeApp(firebaseConfig);
}

const auth=firebase.auth();
const db=firebase.firestore();

auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  loadNasiya(user.uid);
});

function loadNasiya(uid){

  let totalDebt=0;
  let totalItems=0;

  const list=document.getElementById("customerList");
  list.innerHTML="";

  db.collection("users")
    .doc(uid)
    .collection("debts")
    .get()
    .then(snapshot=>{

      if(snapshot.empty){
        list.innerHTML="<p style='opacity:0.6'>Nasiya yo‚Äòq</p>";
      }

      snapshot.forEach(async doc=>{

        const data=doc.data();
        const name=doc.id;

        const debt=Number(data.totalDebt||0);
        const itemsCount=Number(data.totalItems||0);

        totalDebt+=debt;
        totalItems+=itemsCount;

        const div=document.createElement("div");
        div.className="customer";
        div.innerHTML=`
          <h4>üë§ ${name}</h4>
          <p>üì¶ ${itemsCount} ta | üí∞ ${debt.toLocaleString()} so‚Äòm</p>
          <div class="section-title">üõí Olingan mahsulotlar:</div>
          <div id="items-${name}"></div>
          <div class="section-title">üí∏ To‚Äòlovlar:</div>
          <div id="payments-${name}"></div>
        <button class="pay-btn" onclick="openModal('${name}')">üí∏ To‚Äòlandi</button>
        `;
        list.appendChild(div);

        const itemsSnap=await db.collection("users").doc(uid)
          .collection("debts").doc(name)
          .collection("items")
          .orderBy("createdAt","desc").get();

        const itemsContainer=document.getElementById("items-"+name);

        itemsSnap.forEach(itemDoc=>{
          const item=itemDoc.data();
          const date=item.createdAt?item.createdAt.toDate().toLocaleString("uz-UZ"):"";
          itemsContainer.innerHTML+=`
            <div class="item-line">
              ‚Ä¢ ${item.spareName} - ${item.price.toLocaleString()} so‚Äòm
              <span style="opacity:0.5">(${date})</span>
            </div>`;
        });

        const paySnap=await db.collection("users").doc(uid)
          .collection("debts").doc(name)
          .collection("payments")
          .orderBy("createdAt","desc").get();

        const payContainer=document.getElementById("payments-"+name);

        paySnap.forEach(payDoc=>{
          const p=payDoc.data();
          const date=p.createdAt?p.createdAt.toDate().toLocaleString("uz-UZ"):"";
          payContainer.innerHTML+=`
            <div class="payment-line">
              ‚Ä¢ ${p.amount.toLocaleString()} so‚Äòm
              <span style="opacity:0.5">(${date})</span>
            </div>`;
        });

      });

      document.getElementById("totalDebt").innerText=
        totalDebt.toLocaleString()+" so‚Äòm";

      document.getElementById("totalItems").innerText=
        totalItems+" ta";

    });
}



  const user=auth.currentUser;
  if(!user) return;

  const uid=user.uid;

  const debtRef=db.collection("users").doc(uid)
    .collection("debts").doc(customerName);

  const doc=await debtRef.get();
  if(!doc.exists) return;

  const currentDebt=doc.data().totalDebt||0;
  const newDebt=currentDebt-amount;

  await debtRef.collection("payments").add({
    amount:amount,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection("users").doc(uid).collection("sales").add({
    name:"Nasiya to‚Äòlov ("+customerName+")",
    price:amount,
    type:"payment",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  if(newDebt<=0){
    await debtRef.delete();
  }else{
    await debtRef.update({
      totalDebt:newDebt,
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  location.reload();
}
 
</script>

</body>
</html>
