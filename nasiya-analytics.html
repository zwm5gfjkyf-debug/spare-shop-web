<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Nasiya Tahlil</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  padding:20px;
}

h2{
  text-align:center;
  margin-bottom:25px;
}

.stats{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
  margin-bottom:30px;
}

.card{
  background:rgba(255,255,255,0.08);
  padding:20px;
  border-radius:18px;
}

.card h3{
  margin:0 0 10px;
  font-size:14px;
  opacity:0.8;
}

.card p{
  font-size:20px;
  font-weight:600;
  margin:0;
}

.customer{
  background:rgba(255,255,255,0.07);
  padding:18px;
  border-radius:16px;
  margin-bottom:15px;
}

.section-title{
  margin-top:12px;
  font-size:13px;
  opacity:0.7;
}

.item-line{
  font-size:13px;
  opacity:0.9;
  margin:4px 0;
}

.payment-line{
  font-size:13px;
  color:#22c55e;
  margin:4px 0;
}

.pay-btn{
  margin-top:12px;
  padding:8px 14px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
  background:#16a34a;
  color:white;
}

.back-btn{
  margin-top:25px;
  width:100%;
  padding:16px;
  border:none;
  border-radius:18px;
  background:linear-gradient(90deg,#3b82f6,#2563eb);
  color:white;
  font-size:18px;
  cursor:pointer;
}
</style>
</head>

<body>

<h2>üí≥ Nasiya Tahlil</h2>

<div class="stats">
  <div class="card">
    <h3>üì¶ Jami nasiya tovar</h3>
    <p id="totalItems">0 ta</p>
  </div>

  <div class="card">
    <h3>üí∞ Umumiy nasiya summa</h3>
    <p id="totalDebt">0 so‚Äòm</p>
  </div>
</div>

<div id="customerList"></div>

<button class="back-btn" onclick="location.href='dashboard.html'">
‚Üê Orqaga
</button>

<script>

const firebaseConfig={
  apiKey:"AIzaSyAlE6UaaXEl2FnDI6fyMWyr4IV-j1BkJ6U",
  authDomain:"spare-shop-web.firebaseapp.com",
  projectId:"spare-shop-web",
  storageBucket:"spare-shop-web.firebasestorage.app",
  messagingSenderId:"960113811021",
  appId:"1:960113811021:web:8ae1451d3cba1148a0c604"
};

firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  loadNasiya(user.uid);
});

function loadNasiya(uid){

  let totalDebt = 0;
  let totalItems = 0;

  const list = document.getElementById("customerList");
  list.innerHTML = "";

  db.collection("users")
    .doc(uid)
    .collection("debts")
    .get()
    .then(snapshot=>{

      if(snapshot.empty){
        list.innerHTML = "<p>Nasiya yo‚Äòq</p>";
      }

      snapshot.forEach(async doc=>{

        const data = doc.data();
        const name = doc.id;

        const debt = Number(data.totalDebt || 0);
        const itemsCount = Number(data.totalItems || 0);

        totalDebt += debt;
        totalItems += itemsCount;

        const div = document.createElement("div");
        div.className = "customer";

        div.innerHTML = `
          <h4>üë§ ${name}</h4>
          <p>üì¶ Tovar: ${itemsCount} ta</p>
          <p>üí∞ Qarzi: ${debt.toLocaleString()} so‚Äòm</p>
          <div class="section-title">üõí Olingan mahsulotlar:</div>
          <div id="items-${name}"></div>
          <div class="section-title">üí∏ To‚Äòlovlar:</div>
          <div id="payments-${name}"></div>
          <button class="pay-btn" onclick="payDebt('${name}')">üí∏ To‚Äòlandi</button>
        `;

        list.appendChild(div);

        /* LOAD ITEMS */
        /* LOAD ITEMS (NEW STRUCTURE) */
const itemsContainer = document.getElementById("items-"+name);

const itemsSnap = await db
  .collection("users")
  .doc(uid)
  .collection("debts")
  .doc(name)
  .collection("items")
  .orderBy("createdAt","desc")
  .get();

if(!itemsSnap.empty){
  itemsSnap.forEach(itemDoc=>{
    const item = itemDoc.data();
    const date = item.createdAt
      ? item.createdAt.toDate().toLocaleString("uz-UZ")
      : "";
    itemsContainer.innerHTML += `
      <div class="item-line">
        ‚Ä¢ ${item.spareName} - ${item.price.toLocaleString()} so‚Äòm 
        <span style="opacity:0.6;">(${date})</span>
      </div>
    `;
  });
}

/* LOAD ITEMS (OLD STRUCTURE COMPATIBILITY) */
const oldSnap = await db
  .collection("users")
  .doc(uid)
  .collection("nasiyaSales")
  .where("customer","==",name)
  .orderBy("createdAt","desc")
  .get();

oldSnap.forEach(oldDoc=>{
  const item = oldDoc.data();
  const date = item.createdAt
    ? item.createdAt.toDate().toLocaleString("uz-UZ")
    : "";
  itemsContainer.innerHTML += `
    <div class="item-line">
      ‚Ä¢ ${item.name} - ${item.price.toLocaleString()} so‚Äòm 
      <span style="opacity:0.6;">(${date})</span>
    </div>
  `;
});

        /* LOAD PAYMENTS */
        const paySnap = await db
          .collection("users")
          .doc(uid)
          .collection("debts")
          .doc(name)
          .collection("payments")
          .orderBy("createdAt","desc")
          .get();

        const payContainer = document.getElementById("payments-"+name);

        paySnap.forEach(payDoc=>{
          const p = payDoc.data();
          const date = p.createdAt
            ? p.createdAt.toDate().toLocaleString("uz-UZ")
            : "";
          payContainer.innerHTML += `
            <div class="payment-line">
              ‚Ä¢ ${p.amount.toLocaleString()} so‚Äòm 
              <span style="opacity:0.6;">(${date})</span>
            </div>
          `;
        });

      });

      document.getElementById("totalDebt").innerText =
        totalDebt.toLocaleString()+" so‚Äòm";

      document.getElementById("totalItems").innerText =
        totalItems+" ta";

    });
}

/* PAYMENT SYSTEM */
async function payDebt(customerName){

  const amount = Number(prompt("Qancha to‚Äòlandi?"));

  if(!amount || amount <= 0){
    alert("To‚Äòg‚Äòri summa kiriting");
    return;
  }

  const user = auth.currentUser;
  if(!user) return;

  const uid = user.uid;

  const debtRef = db
    .collection("users")
    .doc(uid)
    .collection("debts")
    .doc(customerName);

  const doc = await debtRef.get();
  if(!doc.exists) return;

  const currentDebt = doc.data().totalDebt || 0;
  const newDebt = currentDebt - amount;

  await debtRef.collection("payments").add({
    amount: amount,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection("users")
    .doc(uid)
    .collection("sales")
    .add({
      name: "Nasiya to‚Äòlov (" + customerName + ")",
      price: amount,
      type: "payment",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  if(newDebt <= 0){
    await debtRef.delete();
  } else {
    await debtRef.update({
      totalDebt: newDebt,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  location.reload();
}

</script>

</body>
</html>
